<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Technics RS-M250 Hybrid (V3.58 - Spaced Reels)</title>
<style>
    /* --- VARIABLES --- */
    :root {
        /* WOOD & SILVER THEME */
        --wood-texture: repeating-linear-gradient(90deg, #5c4033, #8b5a2b 2px, #5c4033 6px);
        --wood-border: #3e2723;
        
        /* BRUSHED NICKEL FACE */
        --brushed-nickel: 
            linear-gradient(180deg, rgba(255,255,255,0.3) 0%, rgba(0,0,0,0.1) 100%),
            repeating-linear-gradient(90deg, #b0b0b0 0px, #dcdcdc 1px, #b0b0b0 2px);
            
        --chrome-gradient: linear-gradient(135deg, #fff 0%, #999 50%, #fff 100%);
        
        /* VU METER */
        --meter-bg: #181008; 
        --meter-markings: #e0c0a0; 
        --meter-arc-normal: #ffffff; 
        --meter-arc-red: #ff0000;    
        --meter-amber-glow: radial-gradient(circle at 50% 90%, rgba(255, 140, 0, 0.6) 0%, rgba(255, 100, 0, 0.2) 50%, transparent 100%);
        
        /* POWER */
        --power-off: #333; /* High contrast dark grey for icon when off */
        --power-on-neon: #00ffff;
        
        /* LEDS */
        --led-off: #333; 
        --led-white-on: #00e6cc; 
        --led-red-on: #ff0000;
        --vfd-green: #00ff41;
        
        /* BUTTON LEDS */
        --play-led-color: #00ff00;
        --selector-led-on: #00ffff;
        
        /* TAPE TYPES */
        --tape-gold: linear-gradient(to bottom, #cfb568 0%, #e6d395 40%, #b89745 100%);
        --tape-red: linear-gradient(to bottom, #ff9999 0%, #cc0000 40%, #880000 100%);
        --tape-green: linear-gradient(to bottom, #99ff99 0%, #00cc00 40%, #006600 100%);
        --tape-orange: linear-gradient(to bottom, #ffb74d 0%, #f57c00 40%, #e65100 100%);
        
        /* CASSETTE */
        --cassette-body: #1a1a1a;
        --tape-metal: #252525;
        
        --ui-font: 'Arial', sans-serif;
    }

    body {
        background: #111;
        background-image: radial-gradient(circle at center, #222 0%, #000 100%);
        height: 100vh;
        margin: 0;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        padding-top: 20px; 
        font-family: var(--ui-font);
        color: #333;
        overflow-x: hidden;
        user-select: none;
    }

    .scene-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 30px;
        transform: scale(0.85); 
        transform-origin: top center;
        perspective: 1200px;
        margin-bottom: -60px; 
        position: relative;
        z-index: 10;
    }
    
    .deck-wrapper-row {
        display: flex;
        align-items: flex-end;
        gap: 60px;
    }

    /* --- WOOD CABINET --- */
    .wood-case {
        padding: 15px; 
        background: var(--wood-texture);
        border-radius: 4px;
        box-shadow: 0 50px 100px rgba(0,0,0,0.9), inset 0 0 30px rgba(0,0,0,0.7);
        position: relative;
    }
    .wood-case::before { content:''; position:absolute; top:0; left:0; width:15px; height:100%; background:rgba(0,0,0,0.2); }
    .wood-case::after { content:''; position:absolute; top:0; right:0; width:15px; height:100%; background:rgba(0,0,0,0.2); }

    .foot { position: absolute; bottom: -15px; width: 60px; height: 20px; background: linear-gradient(to right, #333, #999, #333); border-radius: 0 0 10px 10px; box-shadow: 0 5px 10px rgba(0,0,0,0.8); }
    .foot.left { left: 40px; } .foot.right { right: 40px; }

    /* --- FACEPLATE --- */
    .deck-body {
        width: 1500px; 
        height: 650px;
        background: var(--brushed-nickel);
        border: 1px solid #999;
        border-top: 1px solid #eee;
        box-shadow: inset 0 0 30px rgba(0,0,0,0.1), inset 0 2px 5px rgba(255,255,255,0.7);
        display: flex;
        flex-direction: column;
        padding: 40px 60px; 
        box-sizing: border-box;
        position: relative;
    }

    .brand-group { position: absolute; top: 30px; left: 60px; }
    .logo { font-family: 'Helvetica', sans-serif; font-weight: 900; font-size: 32px; text-transform: uppercase; color: #111; letter-spacing: -1px; text-shadow: 0 1px 0 rgba(255,255,255,0.5); }
    .model { font-size: 12px; font-weight: bold; color: #555; letter-spacing: 2px; margin-top: 2px; font-family: 'Brush Script MT', cursive; font-style: italic;}

    /* COUNTER & TIME DISPLAY */
    .counter-wrapper { 
        position: absolute; top: 35px; right: 520px; 
        display: flex; align-items: center; gap: 15px; 
        background: #222; padding: 5px 15px; 
        border: 2px solid #555; border-radius: 2px; 
        box-shadow: inset 0 0 5px #000, 0 1px 0 #fff; z-index: 20;
    }
    .counter-group { display: flex; align-items: center; gap: 5px; }
    .counter-label { font-size: 9px; color: #888; font-weight: bold; }
    .counter-digits { font-family: 'Courier New', monospace; font-size: 20px; color: var(--vfd-green); letter-spacing: 2px; font-weight: bold; text-shadow: 0 0 5px var(--vfd-green); }
    .reset-button { width: 8px; height: 8px; background: #888; border-radius: 50%; cursor: pointer; border: 1px solid #aaa; }
    
    .time-digits { 
        font-family: 'Consolas', monospace; font-size: 14px; 
        color: #ffaa00; font-weight: bold; letter-spacing: 1px;
        text-shadow: 0 0 3px #ffaa00; 
        border-left: 1px solid #444; padding-left: 10px;
    }

    /* Screws */
    .screw { width: 14px; height: 14px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, #fff 0%, #bbb 100%); border: 1px solid #888; position: absolute; box-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
    .screw::after { content: '+'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -55%); font-family: monospace; font-size: 16px; color: #666; font-weight: bold; }
    .screw.tl { top: 10px; left: 10px; } .screw.tr { top: 10px; right: 10px; }
    .screw.bl { bottom: 10px; left: 10px; } .screw.br { bottom: 10px; right: 10px; }

    /* TOP PANEL */
    .top-panel { display: flex; justify-content: space-between; align-items: flex-start; margin-top: 60px; height: 260px; }
    .readout-panel { flex: 1; margin-right: 40px; display: flex; flex-direction: column; position: relative; }

    /* === VU METERS === */
    .vu-group { display: flex; gap: 20px; width: 100%; height: 150px; align-items: center; margin-bottom: 10px; margin-top: 10px; }
    .vu-meter { 
        flex: 1; height: 100%; background: var(--meter-bg); 
        border: 4px solid #ccc; border-radius: 2px; 
        box-shadow: inset 0 0 30px #000, 1px 1px 5px rgba(0,0,0,0.3);
        position: relative; overflow: hidden; 
    }
    .vu-backlight { 
        position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
        background: var(--meter-amber-glow); 
        opacity: 0; transition: opacity 0.08s; mix-blend-mode: screen; 
    }
    .deck-body.powered-on .vu-backlight { opacity: 0.6; animation: bulbFlicker 0.1s infinite alternate; }
    @keyframes bulbFlicker { 0% { opacity: 0.6; } 100% { opacity: 0.75; } }
    
    .vu-scale-container { width: 100%; height: 100%; position: absolute; opacity: 1; }
    
    .vu-arc { 
        width: 170px; height: 170px; 
        border-radius: 50%; position: absolute; bottom: -60px; left: 50%; transform: translateX(-50%); 
        background: conic-gradient(from 0deg, transparent 0deg 315deg, var(--meter-arc-normal) 315deg 18deg, var(--meter-arc-red) 18deg 45deg, transparent 45deg);
        -webkit-mask: radial-gradient(farthest-side, transparent calc(100% - 30px), #fff calc(100% - 30px));
        mask: radial-gradient(farthest-side, transparent calc(100% - 30px), #fff calc(100% - 30px));
        opacity: 1.0; z-index: 1;
    }
    .vu-arc-thin { width: 160px; height: 160px; border-radius: 50%; position: absolute; bottom: -55px; left: 50%; transform: translateX(-50%); border-top: 1px solid rgba(255,255,255,0.2); z-index: 0; }
    .vu-symbol { position: absolute; top: 62%; left: 50%; transform: translate(-50%, -50%); font-family: 'Times New Roman', serif; font-style: italic; font-weight: bold; font-size: 14px; color: var(--meter-markings); z-index: 2; text-shadow: 0 0 2px #000; }

    .scale-mark { 
        position: absolute; bottom: 15px; left: 50%; width: 20px; height: 110px; 
        transform-origin: bottom center; text-align: center; color: var(--meter-markings); 
        font-family: 'Arial Narrow', sans-serif; font-size: 11px; font-weight: bold;
        display: flex; justify-content: center; align-items: flex-start; pointer-events: none;
        text-shadow: 0 0 2px #000;
    }
    .m-20 { transform: translateX(-50%) rotate(-45deg); } .m-10 { transform: translateX(-50%) rotate(-25deg); } .m-7  { transform: translateX(-50%) rotate(-15deg); } .m-5  { transform: translateX(-50%) rotate(-8deg); } .m-3  { transform: translateX(-50%) rotate(0deg); } .m0   { transform: translateX(-50%) rotate(10deg); font-size: 12px; color: #fff; } .m1   { transform: translateX(-50%) rotate(18deg); color: #ff0000; } .m3   { transform: translateX(-50%) rotate(30deg); color: #ff0000; } .m5   { transform: translateX(-50%) rotate(45deg); color: #ff0000; }

    .vu-needle { width: 2px; height: 95px; background: #ff2222; position: absolute; bottom: 15px; left: 50%; transform-origin: bottom center; transform: translateX(-50%) rotate(-45deg); transition: transform 0.1s cubic-bezier(0.2, 0.6, 0.3, 1); z-index: 10; box-shadow: 0 0 4px #ff0000; }
    .vu-needle::after { content:''; position:absolute; bottom:-4px; left:-3px; width:8px; height:8px; border-radius:50%; background:#222; border:1px solid #555; }
    .vu-label-text { position: absolute; bottom: 5px; width: 100%; text-align: center; color: var(--meter-markings); font-size: 10px; font-weight: 900; letter-spacing: 1px; text-shadow: 0 0 2px #000; }

    /* VFD (COSY STEREO) */
    .vfd-container { display: flex; flex-direction: column; gap: 25px; width: 100%; padding: 10px 20px; background: #111; border-radius: 2px; border: 1px solid #555; box-shadow: inset 0 0 10px #000; box-sizing: border-box; }
    .channel-row { display: flex; align-items: center; gap: 10px; }
    .ch-label { color: #888; font-size: 10px; font-weight: bold; font-family: sans-serif; width: 12px; }
    .deck-body.powered-on .ch-label { color: #fff; }
    .led-bar { display: flex; gap: 1px; flex-grow: 1; padding: 2px; background: #000; border: 1px solid #333; }
    .led { flex: 1; height: 5px; background-color: var(--led-off); opacity: 0.3; }
    .deck-body.powered-on .led.white-zone.lit { background-color: var(--led-white-on); opacity: 1; box-shadow: 0 0 4px var(--led-white-on); }
    .deck-body.powered-on .led.red-zone.lit { background-color: var(--led-red-on); opacity: 1; box-shadow: 0 0 5px var(--led-red-on); }

    /* CASSETTE DOOR - WIDER */
    .door-frame { 
        width: 450px; 
        height: 100%; 
        background: #d8d8d8; border: 4px solid #d0d0d0; border-bottom: 6px solid #bbb; 
        border-radius: 4px; position: relative; box-shadow: inset 0 0 20px #000, 2px 2px 5px rgba(0,0,0,0.3); overflow: hidden; 
    }
    .glass-door { 
        position: absolute; top: 10px; left: 10px; right: 10px; bottom: 10px; 
        background-color: rgba(0, 100, 100, 0.4); border: 1px solid #4db6ac; 
        border-radius: 2px; z-index: 50; pointer-events: none; 
        box-shadow: inset 0 0 15px rgba(0, 150, 136, 0.6); 
    }
    .glass-door::after { content: ''; position: absolute; top: 0; left: 0; width: 200%; height: 100%; background: linear-gradient(115deg, rgba(200,255,255,0.1) 0%, rgba(200,255,255,0.4) 30%, rgba(200,255,255,0) 100%); transform: skewX(-20deg) translateX(-50px); }
    .cassette-well { width: 100%; height: 100%; background: #222; display: flex; justify-content: center; align-items: center; }
    
    /* CASSETTE SHELL */
    .tape-cartridge { 
        width: 432px; 
        height: 263px; 
        background-color: var(--cassette-body); 
        border-radius: 8px; position: relative; 
        box-shadow: 0 5px 15px rgba(0,0,0,0.8); 
        display: flex; justify-content: center; align-items: center; 
        overflow: hidden;
    }
    
    .tape-art-overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background-size: cover; background-position: center;
        opacity: 0.88; pointer-events: none; z-index: 10; mix-blend-mode: overlay; 
    }

    .tape-cartridge::before { content:''; position:absolute; top:12px; left:12px; width:8px; height:8px; border-radius:50%; background:#555; z-index: 15; }
    .tape-cartridge::after { content:''; position:absolute; top:12px; right:12px; width:8px; height:8px; border-radius:50%; background:#555; z-index: 15; }
    
    /* WIDER RACETRACK WINDOW & SPREAD REELS */
    .tape-window-glass {
        position: absolute; 
        width: 290px; /* INCREASED TO SPREAD REELS */
        height: 95px; 
        top: 50%; left: 50%; transform: translate(-50%, -40%);
        background: transparent; 
        border-radius: 47px; 
        border: 3px solid rgba(255,255,255,0.2); 
        box-shadow: inset 0 0 5px rgba(0,0,0,0.8);
        z-index: 5; display: flex; justify-content: space-between; align-items: center; padding: 0 5px;
    }

    .tape-top-title {
        position: absolute; top: 12px; width: 100%; text-align: center;
        font-family: 'Helvetica', sans-serif; font-weight: 900; font-size: 18px;
        color: #ccc; text-transform: uppercase; letter-spacing: 1px;
        z-index: 20; text-shadow: 0 1px 2px #000; pointer-events: none;
    }

    .tape-label-strip { 
        position: absolute; bottom: 16px; left: 14px; right: 14px; height: 45px;
        background: var(--tape-orange); /* DEFAULT METAL */
        border-radius: 3px; 
        display: flex; justify-content: space-between; align-items: center; padding: 0 20px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.5); font-family: 'Arial', sans-serif; font-weight: bold; color: #fff;
        z-index: 15; transition: background 0.3s;
    }
    .tape-label-content { display: flex; justify-content: space-between; width: 100%; font-size: 18px; font-weight: 900; letter-spacing: 0.5px; text-shadow: 1px 1px 0 #000; }

    /* REELS */
    .reel-hub { width: 81px; height: 81px; border-radius: 50%; position: relative; display: flex; justify-content: center; align-items: center; z-index: 5; }
    .reel-spokes { 
        width: 100%; height: 100%; border-radius: 50%; 
        background: #111; border: 4px solid #ccc; box-shadow: 0 0 5px rgba(0,0,0,0.5);
        background-image: radial-gradient(circle at center, #fff 10%, #888 15%, transparent 16%), conic-gradient(#ccc 0deg 40deg, #222 40deg 120deg, #ccc 120deg 160deg, #222 160deg 240deg, #ccc 240deg 280deg, #222 280deg 360deg);
        box-sizing: border-box;
    }
    
    .tape-supply { 
        position: absolute; border-radius: 50%; 
        background: 
            repeating-radial-gradient(#000 0px, #1a1a1a 1px, #000 2px),
            conic-gradient(from 0deg, transparent 0deg, rgba(255,255,255,0.15) 90deg, transparent 180deg);
        background-blend-mode: screen;
        z-index: -1; 
        box-shadow: 0 0 4px rgba(0,0,0,1.0); 
    }
    
    .ts-left { width: 100px; height: 100px; top: -9.5px; left: -9.5px; }
    .ts-right { width: 75px; height: 75px; top: 3px; left: 3px; }

    .playing .reel-hub, .playing .tape-supply { animation: spin 1.8s linear infinite; }
    .rewinding .reel-hub, .rewinding .tape-supply { animation: spin 0.2s linear infinite reverse; }
    .fforwarding .reel-hub, .fforwarding .tape-supply { animation: spin 0.2s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    /* CONTROLS */
    .control-deck { display: flex; justify-content: space-between; align-items: flex-end; margin-top: auto; padding-bottom: 40px; }
    .piano-keys { display: flex; gap: 8px; background: #2a2a2a; padding: 15px 20px; border-radius: 4px; border: 1px solid #666; box-shadow: inset 0 2px 10px #000; margin-left: 20px; }
    .key { width: 45px; height: 80px; background: linear-gradient(180deg, #e0e0e0 0%, #bfbfbf 10%, #999 50%, #777 51%, #ccc 100%); border-radius: 2px 2px 4px 4px; position: relative; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.6), inset 0 1px 0 rgba(255,255,255,0.8); border-top: 1px solid #fff; border-bottom: 1px solid #444; transition: all 0.1s; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; padding-bottom: 6px; }
    .key:active, .key.pressed { transform: translateY(3px); box-shadow: 0 1px 2px rgba(0,0,0,0.8); background: linear-gradient(180deg, #ccc 0%, #999 50%, #666 51%, #999 100%); height: 77px; }
    .key#btnPlay.led-active { background: radial-gradient(circle at 50% 80%, #ccffcc 0%, #00cc00 100%) !important; box-shadow: 0 0 15px var(--play-led-color), inset 0 0 5px #fff !important; border-color: #008800; }
    .key#btnPlay.led-active .key-symbol { color: #004400; text-shadow: 0 0 2px #fff; }
    .key-rec.pressed { background: radial-gradient(circle at 50% 80%, #ffcccc 0%, #cc0000 100%) !important; box-shadow: 0 0 15px var(--led-red-on), inset 0 0 5px #fff !important; border-color: #880000; }
    .key-rec .key-symbol { color: #500; }
    .key#btnPause.pressed { background: radial-gradient(circle at 50% 80%, #ffeebb 0%, #ffaa00 100%) !important; box-shadow: 0 0 15px #ffaa00, inset 0 0 5px #fff !important; border-color: #885500; }
    .key-label { font-size: 9px; font-weight: 800; color: #222; margin-top: 4px; white-space:nowrap; text-shadow: 0 1px 0 rgba(255,255,255,0.5); }
    .key-symbol { font-size: 15px; font-weight: bold; color: #111; margin-bottom: 2px; }

    /* RIGHT SIDE CONTROLS */
    .right-controls-col { 
        display: flex; flex-direction: column; align-items: center; gap: 25px; 
        margin-right: 0px; 
        padding-left: 80px; 
        width: 380px; 
    }
    .button-groups-row { display: flex; gap: 20px; margin-top: 10px; align-items: center; }
    .tape-selectors, .playback-controls { display: flex; gap: 10px; background: #222; padding: 10px; border-radius: 4px; border: 1px solid #555; box-shadow: inset 0 0 5px #000; }
    .selector-btn { width: 45px; height: 30px; background: linear-gradient(to bottom, #ddd 0%, #999 100%); border: 1px solid #555; border-radius: 2px; font-size: 10px; font-weight: bold; text-align: center; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.5); color: #222; transition: all 0.1s; display: flex; flex-direction: column; justify-content: space-between; align-items: center; padding: 4px 0; position: relative; }
    .selector-btn:active, .selector-btn.active { background: #555; color: #fff; box-shadow: inset 0 2px 5px rgba(0,0,0,0.9); transform: translateY(1px); border-color: #222; }
    .selector-led { width: 14px; height: 5px; background: #333; border-radius: 1px; margin-bottom: 2px; box-shadow: inset 0 0 2px #000; transition: background 0.1s; }
    .selector-btn.active .selector-led { background: var(--selector-led-on); box-shadow: 0 0 6px var(--selector-led-on); }
    .neon-icon { width: 16px; height: 16px; fill: none; stroke: #333; stroke-width: 2; margin-bottom: 2px; filter: drop-shadow(0 0 0 transparent); transition: all 0.2s; }
    .selector-btn.active .neon-icon { stroke: var(--selector-led-on); filter: drop-shadow(0 0 2px var(--selector-led-on)); }

    .power-group { display: flex; flex-direction: column; align-items: center; gap: 8px; margin: 0 15px; padding-bottom: 5px; margin-left: auto; margin-right: 60px; }
    .power-btn-large { width: 65px; height: 65px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, #fdfdfd 0%, #dcdcdc 50%, #b0b0b0 100%); border: 2px solid #fff; box-shadow: 0 4px 8px rgba(0,0,0,0.5), inset 0 1px 2px rgba(255,255,255,0.9); display: flex; justify-content: center; align-items: center; cursor: pointer; transition: all 0.3s; }
    .power-btn-large:active { transform: scale(0.95); }
    .power-symbol { width: 24px; height: 24px; border: 4px solid var(--power-off); border-radius: 50%; border-top-color: transparent; position: relative; transition: all 0.5s; }
    .power-symbol::after { content: ''; position: absolute; top: -6px; left: 50%; transform: translateX(-50%); width: 5px; height: 12px; background: var(--power-off); transition: all 0.5s; }
    .deck-body.powered-on .power-btn-large { background: radial-gradient(circle at 30% 30%, #444 0%, #222 100%); border-color: #555; box-shadow: 0 0 20px var(--power-on-neon); }
    .deck-body.powered-on .power-symbol { border-color: var(--power-on-neon); filter: drop-shadow(0 0 3px var(--power-on-neon)); }
    .deck-body.powered-on .power-symbol::after { background: var(--power-on-neon); }

    .knobs-area { display: flex; gap: 40px; background: transparent; padding: 20px 10px 10px 10px; }
    .knob-unit { display: flex; flex-direction: column; align-items: center; gap: 10px; position: relative; width: 110px; height: 130px; justify-content: center; }
    .knob-scale { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); width: 110px; height: 110px; background: repeating-conic-gradient(from 225deg, #888 0deg 2deg, transparent 2deg 27deg); border-radius: 50%; z-index: 0; pointer-events: none; opacity: 0.5; }
    .knob-val-label { position: absolute; font-size: 12px; font-weight: 900; color: #000; text-shadow: 0 1px 0 rgba(255,255,255,0.8); }
    .knob-val-label.left { bottom: 8px; left: -8px; }
    .knob-val-label.right { bottom: 8px; right: -8px; }
    .knob-body { width: 95px; height: 95px; border-radius: 50%; background: conic-gradient(#eee, #ccc, #999, #ccc, #eee); border: 1px solid #aaa; box-shadow: 0 5px 10px rgba(0,0,0,0.4), inset 0 0 2px rgba(255,255,255,0.8); position: relative; cursor: ns-resize; z-index: 1; margin-top: 10px; }
    .knob-line { position: absolute; top: 8px; left: 50%; width: 5px; height: 28px; background: #222; transform: translateX(-50%); border-radius: 2px; z-index: 5; }
    .knob-text { font-size: 12px; font-weight: bold; color: #222; letter-spacing: 1px; z-index: 2; margin-top: 5px; }

    /* === JEWEL CASE (WIDE + SELECTABLE TEXT) === */
    .jewel-case { 
        width: 544px; 
        height: 680px; 
        background: transparent; border-radius: 4px; position: relative; 
        cursor: pointer; transform-style: preserve-3d; 
        transition: transform 0.8s cubic-bezier(0.4, 0.0, 0.2, 1); z-index: 20; 
    }
    .jewel-case.flipped { transform: rotateY(180deg); }
    .case-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.8s; transform-style: preserve-3d; }
    .case-front, .case-back { position: absolute; top: 0; left: 0; width: 100%; height: 100%; backface-visibility: hidden; background: #fdfdfd; border-radius: 4px; border: 1px solid #333; overflow: hidden; box-shadow: 20px 20px 50px rgba(0,0,0,0.8); }
    .case-front { z-index: 2; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .case-spine { position: absolute; top: 0; left: 0; bottom: 0; width: 30px; background: #111; z-index: 5; border-right: 1px solid #555; }
    .inlay-art { position: absolute; top: 2px; left: 32px; right: 2px; bottom: 2px; background-color: #eee; background-size: cover; background-position: center; display: flex; justify-content: center; align-items: center; color: #888; font-weight: bold; text-align: center; padding: 20px; transition: background-image 0.5s ease-in-out; }
    .case-back { 
        transform: rotateY(180deg); display: flex; flex-direction: column; background: #fffcf5; 
        cursor: auto; /* Show standard cursor for text */
        user-select: text; /* ALLOW TEXT SELECTION */
    }
    .case-spine-back { position: absolute; top: 0; right: 0; bottom: 0; width: 30px; background: #111; z-index: 5; border-left: 1px solid #555; }
    
    .tracklist-header { 
        margin: 50px 45px 15px 25px; font-family: 'Helvetica', sans-serif; font-weight: 900; font-size: 24px; color: #000; text-transform: uppercase; border-bottom: 4px solid #000; padding-bottom: 5px; text-align: left; 
        user-select: text; 
    }
    .tracklist-body { 
        margin: 15px 45px 20px 25px; font-family: 'Arial', sans-serif; font-size: 14px; line-height: 1.8; color: #222; text-align: left; column-count: 2; column-gap: 25px; height: 100%; overflow: auto; 
        user-select: text;
    }
    .track-entry { margin-bottom: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; border-bottom: 1px dotted #aaa; }
    .plastic-cover { 
        position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
        background: linear-gradient(135deg, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0.05) 40%, rgba(255,255,255,0.0) 41%, rgba(255,255,255,0.0) 100%); 
        pointer-events: none; z-index: 10; 
    }

    input[type="file"] { display: none; }

    /* PLAYLIST (Ducked) */
    .playlist-container { 
        width: 1400px; margin-top: -10px; background: #151515; border: 2px solid #333; padding: 10px; border-radius: 4px; box-sizing: border-box; transform: scale(0.85); transform-origin: top center; position: relative; z-index: 5; 
    }
    .playlist-header { color: #888; font-size: 12px; font-weight: bold; margin-bottom: 5px; letter-spacing: 1px; }
    .playlist-display { height: 140px; overflow-y: auto; font-family: monospace; color: #aaa; font-size: 14px; }
    .track { padding: 4px 6px; cursor: pointer; border-bottom: 1px solid #222; }
    .track:hover { background: #222; color: #fff; }
    .track.active { color: orange; font-weight: bold; }
    
    /* CREDIT FOOTER - POLISHED & SELECTABLE */
    .credit-footer {
        width: 100%;
        text-align: center;
        margin-top: 10px;
        font-family: 'Segoe UI', Helvetica, Arial, sans-serif; /* Clean Sans-Serif */
        font-size: 14px; 
        color: #ffffff; 
        letter-spacing: 2px;
        text-transform: uppercase;
        text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        opacity: 0.8;
        user-select: text; /* ALLOW TEXT SELECTION */
        cursor: text;
    }

</style>
</head>
<body>

<div class="scene-container">
    
    <div class="deck-wrapper-row">
        <div class="wood-case">
            <div class="foot left"></div><div class="foot right"></div>
            <div class="deck-body" id="deckBody">
                <div class="screw tl"></div><div class="screw tr"></div>
                <div class="screw bl"></div><div class="screw br"></div>

                <div class="brand-group">
                    <div class="logo">Technics</div>
                    <div class="model">STEREO CASSETTE DECK RS-M250 Hybrid</div>
                </div>

                <div class="counter-wrapper">
                    <div class="counter-group">
                        <div class="counter-label">COUNTER</div>
                        <div class="counter-digits" id="tapeCounter">00000</div>
                        <div class="reset-button" id="btnReset" title="Reset"></div>
                    </div>
                    <div class="time-digits" id="timeDisplay">00:00 / 00:00</div>
                </div>

                <div class="top-panel">
                    <div class="readout-panel">
                        <div class="vu-group">
                            <div class="vu-meter">
                                <div class="vu-backlight"></div>
                                <div class="vu-scale-container">
                                    <div class="vu-arc-thin"></div>
                                    <div class="vu-arc"></div>
                                    <div class="vu-symbol">VU</div>
                                    <div class="scale-mark m-20">-20</div>
                                    <div class="scale-mark m-10">-10</div>
                                    <div class="scale-mark m-7">-7</div>
                                    <div class="scale-mark m-5">-5</div>
                                    <div class="scale-mark m-3">-3</div>
                                    <div class="scale-mark m-1">-1</div>
                                    <div class="scale-mark m0">0</div>
                                    <div class="scale-mark m1">+1</div>
                                    <div class="scale-mark m3">+3</div>
                                    <div class="scale-mark m5">+5</div>
                                </div>
                                <div class="vu-needle" id="needleL"></div>
                                <div class="vu-label-text">LEFT</div>
                            </div>
                            <div class="vu-meter">
                                <div class="vu-backlight"></div>
                                <div class="vu-scale-container">
                                    <div class="vu-arc-thin"></div>
                                    <div class="vu-arc"></div>
                                    <div class="vu-symbol">VU</div>
                                    <div class="scale-mark m-20">-20</div>
                                    <div class="scale-mark m-10">-10</div>
                                    <div class="scale-mark m-7">-7</div>
                                    <div class="scale-mark m-5">-5</div>
                                    <div class="scale-mark m-3">-3</div>
                                    <div class="scale-mark m-1">-1</div>
                                    <div class="scale-mark m0">0</div>
                                    <div class="scale-mark m1">+1</div>
                                    <div class="scale-mark m3">+3</div>
                                    <div class="scale-mark m5">+5</div>
                                </div>
                                <div class="vu-needle" id="needleR"></div>
                                <div class="vu-label-text">RIGHT</div>
                            </div>
                        </div>
                        <div class="vfd-container">
                            <div class="channel-row"><div class="ch-label">L</div><div class="led-bar" id="ledRowL"></div></div>
                            <div class="channel-row"><div class="ch-label">R</div><div class="led-bar" id="ledRowR"></div></div>
                        </div>
                    </div>

                    <div class="door-frame">
                        <div class="glass-door"></div>
                        <div class="cassette-well">
                            <div class="tape-cartridge">
                                <div class="tape-art-overlay" id="tapeArtOverlay"></div>
                                <div class="tape-top-title" id="tapeAlbumTitle">UNIVERSE</div>
                                <div class="tape-window-glass">
                                    <div class="reel-hub">
                                        <div class="tape-supply ts-left" id="tapeSupplyLeft"></div>
                                        <div class="reel-spokes" id="spokeL"></div>
                                    </div>
                                    <div class="reel-hub">
                                        <div class="tape-supply ts-right" id="tapeSupplyRight"></div>
                                        <div class="reel-spokes" id="spokeR"></div>
                                    </div>
                                </div>
                                <div class="tape-label-strip" id="tapeLabelStrip">
                                    <div class="tape-label-content" id="tapeLabelText">
                                        <span>TDK</span> <span style="color:#fff;">MA-R90 | Type IV Metal</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="control-deck">
                    <div class="piano-keys">
                        <div class="key key-rec"><div class="key-symbol">●</div><div class="key-label">REC</div></div>
                        <div class="key" id="btnSeekBwd"><div class="key-symbol">⊲</div><div class="key-label">-5s</div></div>
                        <div class="key" id="btnRew"><div class="key-symbol">«</div><div class="key-label">REW</div></div>
                        <div class="key" id="btnPlay"><div class="key-symbol">▶</div><div class="key-label">PLAY</div></div>
                        <div class="key" id="btnFF"><div class="key-symbol">»</div><div class="key-label">FF</div></div>
                        <div class="key" id="btnSeekFwd"><div class="key-symbol">⊳</div><div class="key-label">+5s</div></div>
                        <div class="key" id="btnStop"><div class="key-symbol">■</div><div class="key-label">STOP</div></div>
                        <div class="key" id="btnPause"><div class="key-symbol">II</div><div class="key-label">PAUSE</div></div>
                        <label class="key">
                            <div class="key-symbol">⏏</div><div class="key-label">EJECT</div>
                            <input type="file" id="folderInput" webkitdirectory directory multiple accept="audio/*, .mp3, .wav, .flac, .ogg, .m4a, image/*">
                        </label>
                    </div>
                    
                    <div class="right-controls-col">
                        <div class="knobs-area">
                            <div class="knob-unit">
                                <div class="knob-scale"></div>
                                <div class="knob-val-label left">-10</div>
                                <div class="knob-val-label right">+10</div>
                                <div class="knob-body" id="knobTreble" style="transform: rotate(0deg);"><div class="knob-line"></div></div>
                                <div class="knob-text">TREBLE</div>
                            </div>
                            <div class="knob-unit">
                                <div class="knob-scale"></div>
                                <div class="knob-val-label left">-10</div>
                                <div class="knob-val-label right">+10</div>
                                <div class="knob-body" id="knobBass" style="transform: rotate(0deg);"><div class="knob-line"></div></div>
                                <div class="knob-text">BASS</div>
                            </div>
                            <div class="knob-unit">
                                <div class="knob-scale"></div>
                                <div class="knob-val-label left">Min</div>
                                <div class="knob-val-label right">Max</div>
                                <div class="knob-body" id="knobVolume" style="transform: rotate(-45deg);"><div class="knob-line"></div></div>
                                <div class="knob-text">VOLUME</div>
                            </div>
                        </div>
                        
                        <div class="button-groups-row">
                            <div class="tape-selectors">
                                <div class="selector-btn" id="btnNorm"><div class="selector-led"></div>NORM</div>
                                <div class="selector-btn" id="btnCrO2"><div class="selector-led"></div>CrO2</div>
                                <div class="selector-btn active" id="btnMetal"><div class="selector-led"></div>METAL</div>
                            </div>

                            <div class="playback-controls">
                                <div class="selector-btn" id="btnShuffle">
                                    <svg class="neon-icon" id="iconShuffleOrder" viewBox="0 0 24 24"><path d="M7 2v20M17 2v20M3 6l4-4 4 4M21 18l-4 4-4-4" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                    <svg class="neon-icon" id="iconShuffleRandom" viewBox="0 0 24 24" style="display:none;"><path d="M16 3h5v5M4 20L21 3M21 16v5h-5M15 15l6 6M4 4l5 5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                    MIX
                                </div>
                                <div class="selector-btn" id="btnLoop">
                                    <svg class="neon-icon" id="iconLoopAll" viewBox="0 0 24 24"><path d="M17 1l4 4-4 4M3 11V9a4 4 0 0 1 4-4h14M7 23l-4-4 4-4M21 13v2a4 4 0 0 1-4 4H3" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                    <svg class="neon-icon" id="iconLoopOne" viewBox="0 0 24 24" style="display:none;"><path d="M17 1l4 4-4 4M3 11V9a4 4 0 0 1 4-4h14M7 23l-4-4 4-4M21 13v2a4 4 0 0 1-4 4H3"/><text x="8.5" y="17" fill="none" stroke="#333" stroke-width="1.5" font-size="8" font-family="Arial" font-weight="bold">1</text></svg>
                                    LOOP
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="power-group">
                        <div class="power-btn-large" id="powerBtn"><div class="power-symbol"></div></div>
                        <div style="font-size:8px; font-weight:bold; color:#444;">POWER</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="jewel-case" id="jewelCase">
            <div class="case-inner">
                <div class="case-front">
                    <div class="case-spine"></div>
                    <div class="inlay-art" id="inlayArt">NO TAPE INSERTED</div>
                    <div class="plastic-cover"></div>
                </div>
                <div class="case-back" id="caseBack">
                    <div class="case-spine-back"></div>
                    <div class="tracklist-header" id="albumTitleBack">ALBUM TITLE</div>
                    <div class="tracklist-body" id="tracklistBack"></div>
                    <div class="plastic-cover"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="credit-footer">
        Dedicated to all Audiophiles. Designed & Developed by Chittaranjan Panda (babuptx [at] gmail)
    </div>

</div>

<div class="playlist-container">
    <div class="playlist-header">SOURCE TAPE MONITOR</div>
    <div class="playlist-display" id="playlistDisplay">
        <div style="padding:5px; color:#444;">[ NO TAPE INSERTED ]</div>
    </div>
</div>

<audio id="audioElement" crossorigin="anonymous"></audio>

<script>
    let audioCtx, source, gainNode, bassNode, trebleNode, splitter, analyserL, analyserR;
    let isCtxInit = false, isPoweredOn = false;
    
    // Playback State
    let playlist = [], albumImages = [];
    let shuffledPlaylist = [];
    let currentTrackIndex = 0, artInterval = null;
    let isPlaying = false;
    let volume = 0.7, bassVal = 0, trebleVal = 0;
    
    // New Logic Flags
    let isShuffle = false;
    let loopMode = 'all'; // 'all' or 'one'

    const audio = document.getElementById('audioElement');
    const playlistDisplay = document.getElementById('playlistDisplay');
    const folderInput = document.getElementById('folderInput');
    const needleL = document.getElementById('needleL');
    const needleR = document.getElementById('needleR');
    const tapeCounter = document.getElementById('tapeCounter');
    const timeDisplay = document.getElementById('timeDisplay');
    const deckBody = document.getElementById('deckBody');
    const tapeArtOverlay = document.getElementById('tapeArtOverlay');
    const tapeAlbumTitle = document.getElementById('tapeAlbumTitle');
    const powerBtn = document.getElementById('powerBtn');
    
    // Tape Reels
    const tapeSupplyLeft = document.getElementById('tapeSupplyLeft');
    const tapeSupplyRight = document.getElementById('tapeSupplyRight');
    
    // Tape Label Elements
    const tapeLabelStrip = document.getElementById('tapeLabelStrip');
    const tapeLabelText = document.getElementById('tapeLabelText');
    
    const jewelCase = document.getElementById('jewelCase');
    const inlayArt = document.getElementById('inlayArt');
    const albumTitleBack = document.getElementById('albumTitleBack');
    const tracklistBack = document.getElementById('tracklistBack');
    const caseBack = document.getElementById('caseBack');

    // Smart Click Handler: Only flip if not selecting text
    jewelCase.addEventListener('click', (e) => {
        const selection = window.getSelection();
        if (selection.toString().length > 0) return; // Don't flip if text selected
        jewelCase.classList.toggle('flipped'); 
    });

    // LED Setup: 46 LEDs (12 White + 34 Red)
    const LED_COUNT = 46; 
    function createLEDs(container) {
        for(let i=0; i<LED_COUNT; i++) {
            const led = document.createElement('div'); led.classList.add('led');
            if(i < 12) led.classList.add('white-zone'); else led.classList.add('red-zone');
            container.appendChild(led);
        }
    }
    createLEDs(document.getElementById('ledRowL')); 
    createLEDs(document.getElementById('ledRowR'));

    function updateRow(row, count) { 
        for(let i=0; i<LED_COUNT; i++) { 
            if(i < count) row.children[i].classList.add('lit'); 
            else row.children[i].classList.remove('lit'); 
        } 
    }

    function playClickSound() {
        const C = window.AudioContext || window.webkitAudioContext;
        const c = new C(); const o = c.createOscillator(); const g = c.createGain();
        o.type = 'square'; o.frequency.setValueAtTime(100, c.currentTime);
        o.frequency.exponentialRampToValueAtTime(40, c.currentTime+0.1);
        g.gain.setValueAtTime(0.5, c.currentTime); g.gain.exponentialRampToValueAtTime(0.01, c.currentTime+0.15);
        o.connect(g); g.connect(c.destination); o.start(); o.stop(c.currentTime+0.2);
    }
    
    function playSwitchSound() {
        const C = window.AudioContext || window.webkitAudioContext;
        const c = new C(); const o = c.createOscillator(); const g = c.createGain();
        o.type = 'square'; o.frequency.setValueAtTime(80, c.currentTime);
        o.frequency.exponentialRampToValueAtTime(20, c.currentTime+0.15);
        g.gain.setValueAtTime(0.6, c.currentTime); g.gain.exponentialRampToValueAtTime(0.01, c.currentTime+0.15);
        o.connect(g); g.connect(c.destination); o.start(); o.stop(c.currentTime+0.2);
    }

    // --- TAPE SELECTOR LOGIC ---
    const btnNorm = document.getElementById('btnNorm');
    const btnCrO2 = document.getElementById('btnCrO2');
    const btnMetal = document.getElementById('btnMetal');
    const selectors = [btnNorm, btnCrO2, btnMetal];
    
    function updateTapeLabel(type) {
        if (type === 'norm') {
            tapeLabelStrip.style.background = 'var(--tape-red)';
            tapeLabelText.innerHTML = '<span>Sony</span> <span>Hi Fi 60 Type 1 Normal Bias</span>';
        } else if (type === 'cro2') {
            tapeLabelStrip.style.background = 'var(--tape-green)';
            tapeLabelText.innerHTML = '<span>Maxell</span> <span>XLII IEC Type II 90</span>';
        } else {
            // METAL: Orange Band, White Text, Specific Model Name
            tapeLabelStrip.style.background = 'var(--tape-orange)';
            tapeLabelText.innerHTML = '<span>TDK</span> <span style="color:#fff;">MA-R90 | Type IV Metal</span>';
        }
    }
    
    // Set Initial State
    updateTapeLabel('metal');
    
    selectors.forEach(btn => {
        btn.addEventListener('click', () => {
            if(!isPoweredOn) return; 
            playSwitchSound();
            selectors.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            if(btn.id === 'btnNorm') updateTapeLabel('norm');
            else if(btn.id === 'btnCrO2') updateTapeLabel('cro2');
            else updateTapeLabel('metal');
        });
    });

    // --- PLAYBACK MODE LOGIC ---
    const btnShuffle = document.getElementById('btnShuffle');
    const btnLoop = document.getElementById('btnLoop');
    const iconShuffleOrder = document.getElementById('iconShuffleOrder');
    const iconShuffleRandom = document.getElementById('iconShuffleRandom');
    const iconLoopAll = document.getElementById('iconLoopAll');
    const iconLoopOne = document.getElementById('iconLoopOne');

    // Helper: Fisher-Yates Shuffle
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    btnShuffle.addEventListener('click', () => {
        if(!isPoweredOn) return;
        playSwitchSound();
        isShuffle = !isShuffle;
        if(isShuffle) {
            btnShuffle.classList.add('active');
            iconShuffleOrder.style.display = 'none';
            iconShuffleRandom.style.display = 'block';
            shuffledPlaylist = shuffleArray([...Array(playlist.length).keys()]);
        } else {
            btnShuffle.classList.remove('active');
            iconShuffleOrder.style.display = 'block';
            iconShuffleRandom.style.display = 'none';
        }
    });

    btnLoop.addEventListener('click', () => {
        if(!isPoweredOn) return;
        playSwitchSound();
        if(loopMode === 'all') {
            loopMode = 'one';
            btnLoop.classList.add('active');
            iconLoopAll.style.display = 'none';
            iconLoopOne.style.display = 'block';
            iconLoopOne.querySelector('text').setAttribute('stroke', 'var(--selector-led-on)');
        } else {
            loopMode = 'all';
            btnLoop.classList.remove('active');
            iconLoopAll.style.display = 'block';
            iconLoopOne.style.display = 'none';
        }
    });

    // --- MAIN POWER LOGIC ---
    powerBtn.addEventListener('click', () => {
        playClickSound(); isPoweredOn = !isPoweredOn;
        if(isPoweredOn) { deckBody.classList.add('powered-on'); } 
        else {
            deckBody.classList.remove('powered-on');
            if(isPlaying) pressKey(btnStop);
            needleL.style.transform = `translateX(-50%) rotate(-45deg)`; needleR.style.transform = `translateX(-50%) rotate(-45deg)`;
            updateRow(document.getElementById('ledRowL'), 0); updateRow(document.getElementById('ledRowR'), 0);
            document.querySelectorAll('.vu-backlight').forEach(el => el.style.opacity = 0);
            timeDisplay.textContent = "00:00 / 00:00";
        }
    });

    function initAudio() {
        if(isCtxInit) return;
        const C = window.AudioContext || window.webkitAudioContext; audioCtx = new C();
        source = audioCtx.createMediaElementSource(audio); 
        bassNode = audioCtx.createBiquadFilter(); bassNode.type = 'lowshelf'; bassNode.frequency.value = 200; bassNode.gain.value = bassVal;
        trebleNode = audioCtx.createBiquadFilter(); trebleNode.type = 'highshelf'; trebleNode.frequency.value = 3000; trebleNode.gain.value = trebleVal;
        gainNode = audioCtx.createGain(); gainNode.gain.value = volume;
        splitter = audioCtx.createChannelSplitter(2); 
        analyserL = audioCtx.createAnalyser(); analyserR = audioCtx.createAnalyser();
        analyserL.fftSize = 256; analyserR.fftSize = 256;
        analyserL.smoothingTimeConstant = 0.8; analyserR.smoothingTimeConstant = 0.8;
        source.connect(bassNode); bassNode.connect(trebleNode); trebleNode.connect(gainNode);
        gainNode.connect(splitter); splitter.connect(analyserL, 0); splitter.connect(analyserR, 1);
        gainNode.connect(audioCtx.destination);
        isCtxInit = true;
    }

    // Helper to format seconds to MM:SS
    function formatTime(s) {
        if (isNaN(s)) return "00:00";
        const m = Math.floor(s / 60);
        const secs = Math.floor(s % 60);
        return `${m.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    // Helper to extract duration for playlist without playing
    function getFileDuration(file) {
        return new Promise((resolve) => {
            const objectUrl = URL.createObjectURL(file);
            const tempAudio = new Audio(objectUrl);
            tempAudio.addEventListener('loadedmetadata', () => {
                const duration = tempAudio.duration;
                URL.revokeObjectURL(objectUrl); 
                resolve(formatTime(duration));
            });
            tempAudio.addEventListener('error', () => resolve("??:??"));
        });
    }

    folderInput.addEventListener('change', async (e) => {
        const allFiles = Array.from(e.target.files);
        const audioExtensions = ['.mp3', '.wav', '.ogg', '.m4a', '.flac'];
        const audioFiles = allFiles.filter(f => {
            const name = f.name.toLowerCase();
            return f.type.startsWith('audio/') || audioExtensions.some(ext => name.endsWith(ext));
        });
        const imageFiles = allFiles.filter(f => f.type.startsWith('image/'));

        if(audioFiles.length > 0) {
            const fullPath = audioFiles[0].webkitRelativePath;
            const folderName = fullPath.split('/')[0];
            albumTitleBack.textContent = folderName;
            tapeAlbumTitle.textContent = folderName; 

            if(imageFiles.length > 0) {
                const imgUrl = URL.createObjectURL(imageFiles[0]);
                tapeArtOverlay.style.backgroundImage = `url(${imgUrl})`;
            } else {
                tapeArtOverlay.style.backgroundImage = 'none';
            }

            albumImages = imageFiles.map(f => URL.createObjectURL(f));
            startArtRotation();

            const randomColor = `hsl(${Math.random() * 360}, 70%, 90%)`;
            caseBack.style.background = randomColor;

            playlist = audioFiles.sort((a,b) => a.name.localeCompare(b.name));
            shuffledPlaylist = shuffleArray([...Array(playlist.length).keys()]);
            
            updateBackCover(playlist); 
            playlistDisplay.innerHTML = '<div style="padding:10px;">Scanning files...</div>';
            
            const listItems = [];
            for (let i = 0; i < playlist.length; i++) {
                const duration = await getFileDuration(playlist[i]);
                const ser = (i + 1).toString().padStart(2, '0');
                const name = playlist[i].name.replace(/\.[^/.]+$/, "");
                listItems.push({ ser, duration, name, index: i });
            }
            
            renderPlaylistWithDurations(listItems);
            
            currentTrackIndex = 0;
            loadTrack(0);
        }
    });

    function renderPlaylistWithDurations(items) {
        playlistDisplay.innerHTML = '';
        items.forEach(item => {
            const div = document.createElement('div');
            div.className = 'track';
            div.textContent = `${item.ser}: (${item.duration}): ${item.name}`;
            div.onclick = () => { loadTrack(item.index); pressKey(btnPlay); };
            playlistDisplay.appendChild(div);
        });
    }

    function renderPlaylist() {
        Array.from(playlistDisplay.children).forEach((child, i) => {
            if(i === currentTrackIndex) child.classList.add('active'); else child.classList.remove('active');
        });
    }

    function startArtRotation() {
        if(artInterval) clearInterval(artInterval);
        if(albumImages.length > 0) {
            let imgIndex = 0;
            const updateArt = () => {
                const imgUrl = albumImages[imgIndex];
                inlayArt.style.backgroundImage = `url(${imgUrl})`;
                inlayArt.textContent = "";
                imgIndex = (imgIndex + 1) % albumImages.length;
            };
            updateArt();
            if(albumImages.length > 1) {
                artInterval = setInterval(updateArt, 5000);
            }
        } else {
            inlayArt.style.backgroundImage = 'none'; inlayArt.textContent = "NO ART";
        }
    }

    function updateBackCover(tracks) {
        tracklistBack.innerHTML = '';
        tracks.forEach((track, index) => {
            const div = document.createElement('div');
            div.className = 'track-entry';
            div.textContent = `${(index+1).toString().padStart(2,'0')}. ${track.name.replace(/\.[^/.]+$/, "")}`;
            tracklistBack.appendChild(div);
        });
    }

    function loadTrack(index) {
        if(index < 0 || index >= playlist.length) return;
        currentTrackIndex = index;
        audio.src = URL.createObjectURL(playlist[index]);
        Array.from(playlistDisplay.children).forEach((child, i) => {
            if(i===index) child.classList.add('active'); else child.classList.remove('active');
        });
        resetCounter();
    }

    const btnPlay = document.getElementById('btnPlay'); const btnPause = document.getElementById('btnPause');
    const btnStop = document.getElementById('btnStop'); const btnRew = document.getElementById('btnRew');
    const btnFF = document.getElementById('btnFF');
    const btnSeekBwd = document.getElementById('btnSeekBwd');
    const btnSeekFwd = document.getElementById('btnSeekFwd');

    function pressKey(key) {
        if(!isPoweredOn && key !== btnStop) return;
        document.querySelectorAll('.key').forEach(k => {
            k.classList.remove('pressed');
            k.classList.remove('led-active'); // Clear LED
        });
        if(key) {
            key.classList.add('pressed');
            if(key === btnPlay && isPlaying) key.classList.add('led-active');
        }

        if(key === btnPlay) {
            if(!isPoweredOn) return;
            initAudio(); if(audioCtx.state === 'suspended') audioCtx.resume();
            audio.play(); isPlaying = true;
            key.classList.add('led-active'); // Ensure LED is on
            deckBody.classList.remove('rewinding', 'fforwarding');
            deckBody.classList.add('playing');
        } else if (key === btnPause) {
            audio.pause(); isPlaying = false;
            deckBody.classList.remove('playing', 'rewinding', 'fforwarding');
            key.classList.add('pressed'); 
        } else if (key === btnStop) {
            audio.pause(); audio.currentTime = 0; isPlaying = false;
            deckBody.classList.remove('playing', 'rewinding', 'fforwarding');
            key.classList.remove('pressed'); 
        }
    }

    btnPlay.addEventListener('click', () => pressKey(btnPlay));
    btnPause.addEventListener('click', () => pressKey(btnPause));
    btnStop.addEventListener('click', () => pressKey(btnStop));

    btnRew.addEventListener('click', () => {
        if(!isPoweredOn) return;
        btnRew.classList.add('pressed'); deckBody.classList.add('rewinding');
        setTimeout(() => { 
            btnRew.classList.remove('pressed'); deckBody.classList.remove('rewinding');
            let prevIndex;
            if (isShuffle) {
                let shufflePos = shuffledPlaylist.indexOf(currentTrackIndex);
                if (shufflePos > 0) prevIndex = shuffledPlaylist[shufflePos - 1];
                else prevIndex = shuffledPlaylist[shuffledPlaylist.length - 1];
            } else {
                prevIndex = (currentTrackIndex - 1 + playlist.length) % playlist.length;
            }
            loadTrack(prevIndex); if(isPlaying) pressKey(btnPlay);
        }, 300);
    });

    btnFF.addEventListener('click', () => {
        if(!isPoweredOn) return;
        btnFF.classList.add('pressed'); deckBody.classList.add('fforwarding');
        setTimeout(() => { 
            btnFF.classList.remove('pressed'); deckBody.classList.remove('fforwarding');
            playNextTrack();
        }, 300);
    });
    
    function playNextTrack() {
        let nextIndex;
        if (isShuffle) {
            let shufflePos = shuffledPlaylist.indexOf(currentTrackIndex);
            if (shufflePos < shuffledPlaylist.length - 1) nextIndex = shuffledPlaylist[shufflePos + 1];
            else nextIndex = shuffledPlaylist[0]; 
        } else {
            nextIndex = (currentTrackIndex + 1) % playlist.length;
        }
        loadTrack(nextIndex); if(isPlaying) pressKey(btnPlay);
    }
    
    // NEW SEEK KEYS
    btnSeekBwd.addEventListener('click', () => {
        if(!isPoweredOn) return;
        btnSeekBwd.classList.add('pressed');
        audio.currentTime = Math.max(0, audio.currentTime - 5);
        setTimeout(() => { 
            btnSeekBwd.classList.remove('pressed');
            if(isPlaying) btnPlay.classList.add('pressed', 'led-active'); // Keep play lit
        }, 200);
    });

    btnSeekFwd.addEventListener('click', () => {
        if(!isPoweredOn) return;
        btnSeekFwd.classList.add('pressed');
        audio.currentTime = Math.min(audio.duration, audio.currentTime + 5);
        setTimeout(() => { 
            btnSeekFwd.classList.remove('pressed');
            if(isPlaying) btnPlay.classList.add('pressed', 'led-active'); // Keep play lit
        }, 200);
    });

    audio.addEventListener('ended', () => {
        if (loopMode === 'one') {
            audio.currentTime = 0;
            audio.play();
        } else {
            if (currentTrackIndex < playlist.length - 1 || loopMode === 'all' || isShuffle) {
                playNextTrack();
            } else {
                pressKey(btnStop);
            }
        }
    });

    function updateCounter() {
        if(isPlaying && isPoweredOn && !audio.paused && audio.duration > 0) {
            const timeVal = Math.floor(audio.currentTime * 10);
            tapeCounter.textContent = timeVal.toString().padStart(5, '0');
            
            // Update Time Display
            const cur = formatTime(audio.currentTime);
            const rem = formatTime(audio.duration - audio.currentTime);
            timeDisplay.textContent = `${cur} / ${rem}`;
            
            // TAPE REEL PHYSICS (Grow/Shrink)
            // SCALE: Min 74px, Max 100px (approx 35% larger than original 55/75)
            const pct = audio.currentTime / audio.duration;
            const leftSize = 100 - (26 * pct);
            const rightSize = 74 + (26 * pct);
            
            const leftOffset = (81 - leftSize) / 2;
            const rightOffset = (81 - rightSize) / 2;
            
            tapeSupplyLeft.style.width = `${leftSize}px`;
            tapeSupplyLeft.style.height = `${leftSize}px`;
            tapeSupplyLeft.style.top = `${leftOffset}px`;
            tapeSupplyLeft.style.left = `${leftOffset}px`;
            
            tapeSupplyRight.style.width = `${rightSize}px`;
            tapeSupplyRight.style.height = `${rightSize}px`;
            tapeSupplyRight.style.top = `${rightOffset}px`;
            tapeSupplyRight.style.left = `${rightOffset}px`;
        }
        requestAnimationFrame(updateCounter);
    }
    updateCounter();
    document.getElementById('btnReset').addEventListener('click', resetCounter);
    function resetCounter() { tapeCounter.textContent = "00000"; }

    function drawVU() {
        if(isCtxInit && isPlaying && isPoweredOn) {
            const dL = new Uint8Array(analyserL.frequencyBinCount);
            const dR = new Uint8Array(analyserR.frequencyBinCount);
            analyserL.getByteFrequencyData(dL); analyserR.getByteFrequencyData(dR);
            let vL = 0, vR = 0;
            for(let i=0; i<dL.length; i++) { vL+=dL[i]; vR+=dR[i]; }
            vL = vL/dL.length; vR = vR/dR.length;

            // Amber Flicker Logic
            const brightness = 0.5 + (vL / 255) * 0.4; 
            document.querySelectorAll('.vu-backlight').forEach(el => el.style.opacity = brightness);

            const degL = Math.min(45, (vL * 0.6) - 45);
            const degR = Math.min(45, (vR * 0.6) - 45);
            needleL.style.transform = `translateX(-50%) rotate(${degL}deg)`;
            needleR.style.transform = `translateX(-50%) rotate(${degR}deg)`;

            const mapLED = (v) => Math.min(Math.floor((v/220)*LED_COUNT), LED_COUNT);
            updateRow(document.getElementById('ledRowL'), mapLED(vL));
            updateRow(document.getElementById('ledRowR'), mapLED(vR));
        } else {
            needleL.style.transform = `translateX(-50%) rotate(-45deg)`;
            needleR.style.transform = `translateX(-50%) rotate(-45deg)`;
            updateRow(document.getElementById('ledRowL'), 0);
            updateRow(document.getElementById('ledRowR'), 0);
        }
        requestAnimationFrame(drawVU);
    }
    drawVU();

    function setupKnob(element, type) {
        let isDragging = false, startY = 0;
        element.addEventListener('mousedown', (e) => { isDragging=true; startY=e.clientY; });
        window.addEventListener('mousemove', (e) => {
            if(!isDragging) return;
            let d = (startY - e.clientY);
            
            if(type === 'vol') {
                let v = volume + (d*0.01);
                if(v > 1) v=1; if(v < 0) v=0;
                volume = v;
                if(gainNode) gainNode.gain.value = volume;
                element.style.transform = `rotate(${(volume * 270) - 135}deg)`;
            } 
            else if(type === 'bass' || type === 'treble') {
                let val = (type === 'bass' ? bassVal : trebleVal) + (d*0.1);
                if(val > 10) val=10; if(val < -10) val=-10;
                if(type === 'bass') { bassVal = val; if(bassNode) bassNode.gain.value = bassVal; }
                else { trebleVal = val; if(trebleNode) trebleNode.gain.value = trebleVal; }
                element.style.transform = `rotate(${val * 13.5}deg)`;
            }
            startY = e.clientY;
        });
        window.addEventListener('mouseup', () => isDragging=false);
    }

    setupKnob(document.getElementById('knobVolume'), 'vol');
    setupKnob(document.getElementById('knobBass'), 'bass');
    setupKnob(document.getElementById('knobTreble'), 'treble');

</script>
</body>
</html>